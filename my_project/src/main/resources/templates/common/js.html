<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>js 집합</title>

    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- OpenLayers JS file -->
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
    <!-- Bootstrap JS file -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script>
        // map 과 markerLayer 를 전역 변수로 설정
        let map;
        let markerLayer;
        let searchMaker;
        let markerStyle;

        //
        // /**
        //  * Elements that make up the popup.
        //  */
        // let container = document.getElementById('popup');
        // let content = document.getElementById('popup-content');
        // let closer = document.getElementById('popup-closer');
        // /**
        //  * Create an overlay to anchor the popup to the map.
        //  */
        // let overlay = new ol.Overlay({
        //     element: container,
        //     autoPan: true,
        //     autoPanAnimation: {
        //         duration: 250
        //     }
        // });
        //
        // /**
        //  * Add a click handler to hide the popup.
        //  * @return {boolean} Don't follow the href.
        //  */
        // closer.onclick = function () {
        //     overlay.setPosition(undefined);
        //     closer.blur();
        //     return false;
        // };
        //
        // /**
        //  * Add a click handler to the map to render the popup.
        //  */
        let mapOverlay;
        let hover = null; //마우스 이벤트에 사용될 변수


        // 팝업 변수 선언
        let hover_container = $('#popup'); //팝업 컨테이너
        let hover_content = $('#popup-content'); //팝업 내용
        function init() {
            mapOverlay = new ol.Overlay(({element: hover_container.get(0)})); //Overlay 생성, 요소는 컨테이너의 첫 번째 요소(Native DOM element)
            // 대한민국 전체 영역 좌표 [xmin, ymin, xmax, ymax]
            const koreaExtent = [124.61, 33.06, 129, 38];
            map = new ol.Map({
                target: 'map',
                layers: [
                    // 지도에 사용할 레이어 생성 (OSM 기반 지도 레이어 사용)
                    new ol.layer.Tile({
                        source: new ol.source.OSM(),
                    }),
                ],
                overlays: [mapOverlay], //오버레이
                view: new ol.View({
                    //Web Mercator 좌표계로 변환
                    extent: ol.proj.transformExtent(koreaExtent, 'EPSG:4326', 'EPSG:3857'),
                    zoom: 7, // 초기 줌 레벨 설정
                    maxZoom: 19, // 지도 줌 레벨의 최대 값 설정
                    minZoom: 9, // 지도 줌 레벨의 최소 값 설정
                }),
            });

            // 마커를 출력할 벡터 레이어 생성
            markerLayer = new ol.layer.Vector({
                source: new ol.source.Vector(),
            });

            // 마커 레이어를 지도에 추가
            map.addLayer(markerLayer);

            // 마커 스타일 정의
            markerStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    // 마커 앵커 포인트 설정 (이미지 기준 x: 50%, y: 100% 위치)
                    anchor: [0.5, 1],
                    // 마커 이미지(아이콘) URL
                    src: '/img/user_maker.png',
                }),
            });
            // 마커 스타일 정의
            searchMaker = new ol.style.Style({
                image: new ol.style.Icon({
                    // 마커 앵커 포인트 설정 (이미지 기준 x: 50%, y: 100% 위치)
                    anchor: [0.5, 1],
                    // 마커 이미지(아이콘) URL
                    src: '/img/search_maker.png',
                }),
            });

            // 현재 위치 표시
            // 브라우저에서 지오로케이션(위치정보)를 지원하는지 확인
            if ('geolocation' in navigator) {
                // 현재 위치를 가져옴
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // 가져온 경도, 위도 좌표를 OpenLayers 지도 좌표계로 변환
                        const coords = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);

                        // 현재 위치 좌표로 지점(포인트) 지오메트리를 가진 피처 생성
                        const markerFeature = new ol.Feature({
                            geometry: new ol.geom.Point(coords),
                        });

                        // 생성한 피처에 마커 스타일을 적용
                        markerFeature.setStyle(markerStyle);

                        // 피처를 마커 레이어의 소스에 추가
                        markerLayer.getSource().addFeature(markerFeature);

                        // 지도 뷰를 현재 위치로 애니메이션 효과와 함께 이동시키고 줌 레벨을 조절
                        map.getView().animate({center: coords, zoom: 14});
                    },
                    // 현재 위치를 가져오는 데 실패한 경우 에러 처리
                    (error) => {
                        console.error('Error getting geolocation', error);
                    }
                );
            } else {
                alert('이 브라우저에서는 지오로케이션을 지원하지 않습니다.');
            }

            // 지도 클릭 시, 피처가 있는지 확인하고 팝업을 표시
            map.on('pointermove', (event) => {
                // 현재 마우스 위치의 좌표를 가져옴
                const coordinate = event.coordinate;

                // 마우스 위치에 마커가 있다면 커서 스타일을 'pointer'로 변경, 그렇지 않으면 기본 스타일 사용
                map.getTargetElement().style.cursor = map.hasFeatureAtPixel(event.pixel) ? 'pointer' : '';

                let hover = null;

                // 현재 마우스 위치에서의 마커를 가져와 hover 변수에 저장
                map.forEachFeatureAtPixel(event.pixel, (feature) => {
                    hover = feature;
                    return true;
                });

                // 수정: 좌표계 변경
                const inputProj = 'EPSG:3857';
                const outputProj = 'EPSG:4326';

                // 마커가 있을 경우
                if (hover) {
                    const lonlat = hover.getGeometry().getCoordinates();
                    const coords = ol.proj.transform(lonlat, inputProj, outputProj);
                    const lon = coords[0];
                    const lat = coords[1];
                    const url = `/poi/hover?lon=${lon}&lat=${lat}`;
                    $.ajax({
                        url: url,
                        type: 'GET',
                        dataType: 'json',
                        success: (data) => {
                            console.log(data);
                            console.log(Object.keys(data)); // 키 목록 출력
                            const dataObj = $(data);
                            // 파싱한 객체에서 POI 이름과 전화번호를 가져와서 팝업 내용에 사용
                            const content = $("<div class='pointeMaker'></div>").append(
                                $("<div class='header'></div>").text("간단 정보"),
                                $("<div class='info'></div>").append(
                                    $("<p></p>").text("장소명: " + (data[0].poi_name || '값 없음')),
                                    $("<p></p>").text("전화번호: " + (data[0].tel_no || '값 없음'))
                                )
                            );

                            hover_content.html(content); // 수정된 부분
                            mapOverlay.setPosition(coordinate);
                        },
                        error: (error) => {
                            console.error('Error fetching data from API', error);
                        }
                    });
                } else {
                    // 마커 위에 마우스 포인터가 없으면 팝업을 숨깁니다.
                    mapOverlay.setPosition(undefined);
                }

                map.on('singleclick', function (evt) {
                    let ff = map.hasFeatureAtPixel(evt.pixel);

                    if (ff === true && hover) {
                        const lonlat = hover.getGeometry().getCoordinates();
                        const coords = ol.proj.transform(lonlat, inputProj, outputProj);
                        const lon = coords[0];
                        const lat = coords[1];

                        const url = `/poi/hover?lon=${lon}&lat=${lat}`;
                        $.ajax({
                            url: url,
                            type: 'GET',
                            dataType: 'json',
                            success: (data) => {
                                console.log("성공")
                                openPoiModal(data[0]);
                            },
                            error: (error) => {
                                console.error('Error fetching data from API', error);
                            }
                        });
                    }
                });
            })

        }


        // -------------------------------------------------------------------------
        let mapObj = null;


        function createMap() {
            let mapContainer = $("#map-container");
            // 동적으로 지도를 생성할 div 요소를 만듭니다.
            let mapElem = $("<div>").css({
                width: "100%",
                height: "400px"
            });
            // 이전에 생성된 지도가 있다면 삭제합니다.
            if (mapObj) {
                mapObj.setTarget(null);
                mapObj = null;
                mapContainer.empty();
            }
            mapContainer.append(mapElem);
            // 새로운 지도 객체를 생성합니다.
            mapObj = new ol.Map({
                target: mapElem[0],
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM(),
                    }),
                ],
                // overlays: [overlay],
                view: new ol.View({
                    center: ol.proj.fromLonLat([126.985302, 37.566671]),
                    zoom: 11
                })
            });
        }

        <!-- 사이드바 안에서 엔터 키로 검색을 했을 때 화면에 값 넘기기 -->
        $(document).keydown(function (e) {
            if (e.target.id === 'searchInput' && e.keyCode === 13) {
                e.preventDefault();
                $('[data-bs-target="#placeName"]').click();
            }
        });

        // 자동으로 지워주는 jQuery
        $('#loginModal').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        });
        $('#signupModal').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        });
        $('#userModify').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        });
        $('#placeDelete').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        })
        $('#placeRegister').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        })
        $('#placeModify').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        })
        // // 버튼에 클릭 이벤트 리스너를 등록합니다.
        // $("#placeRegisterBtn").on("click", function () {
        //     $("#placeRegister").modal("show");
        // });

        // 모달이 완전히 열린 후에 지도 생성
        $("#placeRegister").on("shown.bs.modal", function () {
            createMap();
        });


        function showPois() {
            // AJAX 요청을 이용하여 서버로부터 POI 데이터를 비동기적으로 요청합니다.
            $.ajax({
                type: "GET", // HTTP GET 요청 메서드를 사용합니다.
                url: "/poi", // 요청할 URL 주소입니다.
                success: function (data) { // 성공적인 요청 시의 콜백 함수입니다.
                    let features = []; // 배열을 생성합니다.
                    // POI 데이터 배열에 대해 반복합니다.
                    data.forEach(function (poi) {
                        let feature = new ol.Feature({ // 새로운 Feature 객체를 만듭니다.
                            // POI의 좌표를 이용하여 새로운 Point 객체를 생성합니다.
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([poi.lon, poi.lat])),
                            // POI 이름을 갖는 속성 값을 추가합니다.
                            name: poi.poi_name
                        });
                        features.push(feature); // 생성한 Feature 객체를 배열에 추가합니다.
                    });
                    addMarkersToMap(features); // addMarkersToMap 함수에 Feature 배열을 넘겨 마커를 추가합니다.
                },
                error: function (jqXHR, textStatus, errorThrown) { // 요청이 실패한 경우의 콜백 함수입니다.
                    console.error("Failed to load POIs: " + textStatus + " " + errorThrown);
                }
            });
        }

        function addMarkersToMap(features) {
            // 마커 스타일 설정
            let markerStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    opacity: 1,
                    scale: 1.2,
                    src: 'http://map.vworld.kr/images/ol3/marker_blue.png'
                }),
                zindex: 10
            });

            // 마커 레이어에 들어갈 소스 생성
            let markerSource = new ol.source.Vector({
                features: features
            });

            // 마커 레이어 생성
            let markerLayer = new ol.layer.Vector({
                source: markerSource,
                style: markerStyle
            });

            // 지도에 마커가 그려진 레이어 추가
            map.addLayer(markerLayer);
        }

        // ------------------------------------------------------------
        function searchPoi() {
            const searchTerm = $('#searchInput').val();
            // 값이 비어있을 때 모든 데이터가 출력되지 않기 위한 조건문
            if (!searchTerm.trim()) {
                return;
            }

            $.ajax({
                url: `/poi/search?name=${searchTerm}`,
                type: 'GET',
                success: function (data) {
                    const poiList = $('#poi-list');
                    poiList.empty();
                    $.each(data, function (index, poi) {
                        const itemContainer = $('<div>').addClass('poi-item');

                        const poiInfo = $('<span>').text(`${poi.poi_name} `);
                        itemContainer.append(poiInfo);

                        itemContainer.append(
                            $('<button>')
                                .addClass("btn btn-outline-warning btn-sm ms-2 ms-auto move-button")
                                .text('이동하기')
                                .on('click', function () {
                                    moveToPoi(poi.lat, poi.lon);
                                })
                        );

                        const detailButton = $('<button>')
                            .text('상세보기')
                            .addClass('btn btn-sm btn-outline-info ms-2 move-button')
                            .click(function () {
                                openPoiModal(poi);
                            });
                        itemContainer.append(detailButton);

                        poiList.append(itemContainer);
                    });
                },
                error: function (error) {
                    console.error('Error fetching data from API', error);
                }
            });
        }


        // openPoiModal() 함수 추가
        function openPoiModal(poi) {
            const poiModalBody = $('#poiModalBody');
            poiModalBody.empty().append(
                $('<div class="row"></div>').append(
                    $('<div class="col-4 fw-bold"></div>').text('장소 이름'),
                    $('<div class="col-8"></div>').text(poi.poi_name)
                ),
                $('<div class="row"></div>').append(
                    $('<div class="col-4 fw-bold"></div>').text('위치'),
                    $('<div class="col-8"></div>').append(
                        $('<button class="btn btn-outline-warning btn-sm"></button>')
                            .text('로드뷰로 보기')
                            .on('click', function () {
                                moveToPoi(poi.lat, poi.lon);
                            })
                    )
                ),
                $('<hr>'),
                $('<div class="row"></div>').append(
                    $('<h6></h6>').text('상세 정보'),
                    $('<div class="col-4 fw-bold"></div>').text('전화번호'),
                    $('<div class="col-8"></div>').text(poi.tel_no || '-'),
                    $('<div class="col-4 fw-bold"></div>').text('대분류'),
                    $('<div class="col-8"></div>').text(poi.iclas),
                    $('<div class="col-4 fw-bold"></div>').text('중분류'),
                    $('<div class="col-8"></div>').text(poi.mlsfc || '-'),
                    $('<div class="col-4 fw-bold"></div>').text('소분류'),
                    $('<div class="col-8"></div>').text(poi.sclas || '-'),
                    $('<div class="col-4 fw-bold"></div>').text('상세분류'),
                    $('<div class="col-8"></div>').text(poi.dclas || '-'),
                    $('<div class="col-4 fw-bold"></div>').text('설명'),
                    $('<div class="col-8"></div>').text(poi.memo || '-'),
                    $('<div class="col-4 fw-bold"></div>').text('대표사진'),
                    $('<div class="col-8"></div>').text(poi.memo || '-')
                )
            );
            $('#poiModal').modal('show');
        }

        function moveToPoi(lat, lon) {
            // POI의 위도와 경도 좌표를 OpenLayers 지도 좌표계로 변환
            const coords = ol.proj.fromLonLat([lon, lat]);

            // 지도 뷰를 POI 좌표로 애니메이션 효과와 함께 이동시키고 줌 레벨을 조정
            map.getView().animate({center: coords, zoom: 19});

            // POI 마커 추가
            const markerFeature = new ol.Feature({
                geometry: new ol.geom.Point(coords),
            });
            markerFeature.setStyle(searchMaker);
            markerLayer.getSource().addFeature(markerFeature);
            // 이동 후 화면 가리지 않게 모달창, 사이드바 닫기
            $('#poiModal').modal('hide');
            $('#placeSearch').offcanvas('hide');
        }

        // 대분류를 불러오는 함수
        function loadLCLASCD() {
            $.ajax({
                type: "GET",
                url: "/findDataByLCLASCD",
                success: function (response) {
                    for (let i = 0; i < response.length; i++) {
                        $("#lclascd-select").append(`<option value="${response[i].lclascd}">${response[i].lclasdc}</option>`);
                    }
                },
                error: function () {
                    $('#lclascd-select').append('<option value="error">데이터 로드에 실패했습니다.</option>');
                }
            });
        }

        // 중분류를 불러오는 함수입니다.
        // 이 함수는 대분류값를 받아 대분류 값에 따른 중분류를 불러옴
        function loadMLSFCCD(lclascdValue) {
            $.ajax({
                type: "GET",
                url: "/findDataByLCLASCDAndMLSFCCD",
                data: {lclascd: lclascdValue},
                success: function (response) {
                    $('#mlsfccd-select').empty();
                    $('#mlsfccd-select').append(`<option disabled>중분류명을 선택하세요</option>`);

                    $('#sclascd-select').empty();
                    $('#sclascd-select').append(`<option disabled>소분류명을 선택하세요</option>`);

                    $('#dclascd-select').empty();
                    $('#dclascd-select').append(`<option disabled>상세 분류명을 선택하세요</option>`);

                    $('#bclascd-select').empty();
                    $('#bclascd-select').append(`<option disabled>브랜드 분류명을 선택하세요</option>`);

                    for (let i = 0; i < response.length; i++) {
                        $("#mlsfccd-select").append(`<option value="${response[i].mlsfccd}">${response[i].mlsfcdc}</option>`);
                    }
                },
                error: function () {
                    $('#mlsfccd-select').append('<option value="error">데이터 로드에 실패했습니다.</option>');
                }
            });
        }

        function loadSCLASCD(lclascdValue, mlsfccdValue) {
            if (!mlsfccdValue) {
                $('#sclascd-select').empty();
                $('#sclascd-select').append(`<option value="">소분류명을 선택하세요</option>`);
                return;
            }

            $.ajax({
                type: "GET",
                url: "/findByMLSFCCDAndSCLASCD",
                data: {
                    lclascd: lclascdValue,
                    mlsfccd: mlsfccdValue
                },
                success: function (response) {
                    $('#sclascd-select').empty();
                    $('#sclascd-select').append(`<option value="">소분류명을 선택하세요</option>`);

                    for (let i = 0; i < response.length; i++) {
                        $("#sclascd-select").append(`<option value="${response[i].sclascd}">${response[i].sclasdc}</option>`);
                    }
                },
                error: function () {
                    $('#sclascd-select').append('<option value="error">데이터 로드에 실패했습니다.</option>');
                }
            });
        }

        function loadDCLASCD(lclascdValue, mlsfccdValue, sclascdValue) {
            if (!sclascdValue) {
                $('#dclascd-select').empty();
                $('#dclascd-select').append(`<option value="">상세 분류명을 선택하세요</option>`);
                return;
            }

            $.ajax({
                type: "GET",
                url: "/findBySCLASCDAndDCLASCD",
                data: {
                    lclascd: lclascdValue,
                    mlsfccd: mlsfccdValue,
                    sclascd: sclascdValue
                },
                success: function (response) {
                    $('#dclascd-select').empty();
                    $('#dclascd-select').append(`<option value="">상세 분류명을 선택하세요</option>`);

                    for (let i = 0; i < response.length; i++) {
                        $("#dclascd-select").append(`<option value="${response[i].dclascd}">${response[i].dclasdc}</option>`);
                    }
                },
                error: function () {
                    $('#dclascd-select').append('<option value="error">데이터 로드에 실패했습니다.</option>');
                }
            });
        }

        function loadBCLASCD(lclascdValue, mlsfccdValue, sclascdValue, dclascdValue) {
            if (!dclascdValue) {
                $('#bclascd-select').empty();
                $('#bclascd-select').append(`<option value="">브랜드 분류명을 선택하세요</option>`);
                return;
            }

            $.ajax({
                type: "GET",
                url: "/findByDCLASCDAndBCLASCD",
                data: {
                    lclascd: lclascdValue,
                    mlsfccd: mlsfccdValue,
                    sclascd: sclascdValue,
                    dclascd: dclascdValue
                },
                success: function (response) {
                    $('#bclascd-select').empty();
                    $('#bclascd-select').append(`<option value="">브랜드 분류명을 선택하세요</option>`);

                    for (let i = 0; i < response.length; i++) {
                        $("#bclascd-select").append(`<option value="${response[i].bclascd}">${response[i].bclasdc}</option>`);
                    }
                },
                error: function () {
                    $('#bclascd-select').append('<option value="error">데이터 로드에 실패했습니다.</option>');
                }
            });
        }

        function resetSelectBoxes() {
            $('#mlsfccd-select').empty().append(`<option disabled selected>중분류명을 선택하세요</option>`);
            $('#sclascd-select').empty().append(`<option disabled selected>소분류명을 선택하세요</option>`);
            $('#dclascd-select').empty().append(`<option disabled selected>상세 분류명을 선택하세요</option>`);
            $('#bclascd-select').empty().append(`<option disabled selected>브랜드 분류명을 선택하세요</option>`);
        }

        function resetSubCategories() {
            $('#sclascd-select').empty().append(`<option disabled selected>소분류명을 선택하세요</option>`);
            $('#dclascd-select').empty().append(`<option disabled selected>상세 분류명을 선택하세요</option>`);
            $('#bclascd-select').empty().append(`<option disabled selected>브랜드 분류명을 선택하세요</option>`);
        }

        $(document).ready(function () {
            init();
            searchPoi();
            // 초기에 대분류 목록을 불러옵니다.
            loadLCLASCD();

            // 대분류가 변경되면 중분류 목록을 불러옵니다.
            $('#lclascd-select').change(function () {
                loadMLSFCCD($(this).val());
                if (lclascdValue) {
                    loadMLSFCCD(lclascdValue);
                } else {
                    resetSelectBoxes();
                }
                resetSubCategories();

            });

            // 중분류가 변경되면 소분류 목록을 불러옵니다.
            $('#mlsfccd-select').change(function () {
                loadSCLASCD($('#lclascd-select').val(), $(this).val());
            });

            // 소분류가 변경되면 상세 분류 목록을 불러옵니다.
            $('#sclascd-select').change(function () {
                loadDCLASCD($('#lclascd-select').val(), $('#mlsfccd-select').val(), $(this).val());
            });

            // 상세분류가 변경되면 브랜드 분류 목록을 불러옵니다.
            $('#dclascd-select').change(function () {
                loadBCLASCD($('#lclascd-select').val(), $('#mlsfccd-select').val(), $('#sclascd-select').val(), $(this).val());
            });
        });

    </script>
</head>
</html>