<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>js 집합</title>

    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- OpenLayers JS file -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>

    <!-- Bootstrap JS file -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"></script>
    <script>
        const map = new ol.Map({
            target: 'map',
            layers: [
                // 지도에 사용할 레이어 생성 (OSM 기반 지도 레이어 사용)
                new ol.layer.Tile({
                    source: new ol.source.OSM(),
                }),
            ],
            view: new ol.View({
                // 초기 중심 좌표와 줌 레벨 설정
                center: ol.proj.fromLonLat([126.985302, 37.566671]),
                zoom: 7
            }),
        });
        // 마커를 출력할 벡터 레이어 생성
        const markerLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
        });

        // 마커 레이어를 지도에 추가
        map.addLayer(markerLayer);

        // 마커 스타일 정의
        const markerStyle = new ol.style.Style({
            image: new ol.style.Icon({
                // 마커 앵커 포인트 설정 (이미지 기준 x: 50%, y: 100% 위치)
                anchor: [0.5, 1],
                // 마커 이미지(아이콘) URL
                src: '/img/user_maker.png',
            }),
        });

        // 현재 위치 표시
        // 브라우저에서 지오로케이션(위치정보)를 지원하는지 확인
        if ('geolocation' in navigator) {
            // 현재 위치를 가져옴
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // 가져온 경도, 위도 좌표를 OpenLayers 지도 좌표계로 변환
                    const coords = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);

                    // 현재 위치 좌표로 지점(포인트) 지오메트리를 가진 피처 생성
                    const markerFeature = new ol.Feature({
                        geometry: new ol.geom.Point(coords),
                    });

                    // 생성한 피처에 마커 스타일을 적용
                    markerFeature.setStyle(markerStyle);

                    // 피처를 마커 레이어의 소스에 추가
                    markerLayer.getSource().addFeature(markerFeature);

                    // 지도 뷰를 현재 위치로 애니메이션 효과와 함께 이동시키고 줌 레벨을 조절
                    map.getView().animate({center: coords, zoom: 14});
                },
                // 현재 위치를 가져오는 데 실패한 경우 에러 처리
                (error) => {
                    console.error('Error getting geolocation', error);
                }
            );
        } else {
            alert('이 브라우저에서는 지오로케이션을 지원하지 않습니다.');
        }

        // -------------------------------------------------------------------------
        var mapObj = null;

        function createMap() {
            var mapContainer = document.getElementById("map-container");
            // 동적으로 지도를 생성할 div 요소를 만듭니다.
            var mapElem = document.createElement("div");
            mapElem.style.width = "100%";
            mapElem.style.height = "400px";
            // 이전에 생성된 지도가 있다면 삭제합니다.
            if (mapObj) {
                mapObj.setTarget(null);
                mapObj = null;
                mapContainer.innerHTML = "";
            }
            mapContainer.append(mapElem);
            // 새로운 지도 객체를 생성합니다.
            mapObj = new ol.Map({
                target: mapElem,
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM({
                            wrapX: false
                        })
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([126.985302, 37.566671]),
                    zoom: 11
                })
            });
        }

        // 문서가 로드된 뒤 아래 코드가 실행됩니다.
        $(document).ready(function () {
            // 버튼에 클릭 이벤트 리스너를 등록합니다.
            $("#placeRegisterBtn").on("click", function () {
                createMap();
            });
        });

        <!-- 사이드바 안에서 검색을 했을 때 화면에 값 넘기기 -->
        let searchKeyword = "";

        $('[data-bs-target="#placeName"]').click(function () {
            searchKeyword = $("#searchInput").val();
            $("#searchResult").text("'" + searchKeyword + "' 검색 결과입니다.");
        });

        <!-- 사이드바 안에서 엔터 키로 검색을 했을 때 화면에 값 넘기기 -->
        $(document).keydown(function (e) {
            if (e.target.id === 'searchInput' && e.keyCode === 13) {
                e.preventDefault();
                $('[data-bs-target="#placeName"]').click();
            }
        });
        //클릭하기
        map.on('click', function (evt) {

            //var lonlat = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326');
            let coordinate = evt.coordinate;
            console.log(coordinate);
        })
        // 자동으로 지워주는 jQuery
        $('#loginModal').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        });
        $('#signupModal').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        });
        $('#userModify').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        });
        $('#placeDelete').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        })
        $('#placeRegister').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        })
        $('#placeModify').on('hidden.bs.modal', function () {
            $(this).find('form').trigger('reset');
        })

        function showPois() {
            // AJAX 요청을 이용하여 서버로부터 POI 데이터를 비동기적으로 요청합니다.
            $.ajax({
                type: "GET", // HTTP GET 요청 메서드를 사용합니다.
                url: "/poi", // 요청할 URL 주소입니다.
                success: function (data) { // 성공적인 요청 시의 콜백 함수입니다.
                    var features = []; // 배열을 생성합니다.
                    // POI 데이터 배열에 대해 반복합니다.
                    data.forEach(function (poi) {
                        var feature = new ol.Feature({ // 새로운 Feature 객체를 만듭니다.
                            // POI의 좌표를 이용하여 새로운 Point 객체를 생성합니다.
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([poi.lon, poi.lat])),
                            // POI 이름을 갖는 속성 값을 추가합니다.
                            name: poi.poi_name
                        });
                        features.push(feature); // 생성한 Feature 객체를 배열에 추가합니다.
                    });
                    addMarkersToMap(features); // addMarkersToMap 함수에 Feature 배열을 넘겨 마커를 추가합니다.
                },
                error: function (jqXHR, textStatus, errorThrown) { // 요청이 실패한 경우의 콜백 함수입니다.
                    console.error("Failed to load POIs: " + textStatus + " " + errorThrown);
                }
            });
        }

        function addMarkersToMap(features) {
            // 마커 스타일 설정
            var markerStyle = new ol.style.Style({
                image: new ol.style.Icon({
                    opacity: 1,
                    scale: 1.2,
                    src: 'http://map.vworld.kr/images/ol3/marker_blue.png'
                }),
                zindex: 10
            });

            // 마커 레이어에 들어갈 소스 생성
            var markerSource = new ol.source.Vector({
                features: features
            });

            // 마커 레이어 생성
            var markerLayer = new ol.layer.Vector({
                source: markerSource,
                style: markerStyle
            });

            // 지도에 마커가 그려진 레이어 추가
            map.addLayer(markerLayer);
        }

        // ------------------------------------------------------------
        function loadPois() {
            $.ajax({
                type: "GET",
                url: "/poi",
                success: function (data) {
                    var tbody = $("#poi-table tbody");
                    tbody.empty();
                    data.forEach(function (poi) {
                        tbody.append(`<tr><td>${poi.poi_name}</td></tr>`);
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error("Failed to load POIs: " + textStatus + " " + errorThrown);
                }
            });
        }


        // 검색 기능 추가
        $("#searchInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            // 숨기기 토글 및 값이 비어있지 않으면 테이블 표시
            var isVisibleRowCount = 0;
            $("#poi-table tbody tr").filter(function () {
                var isVisible = $(this).text().toLowerCase().indexOf(value) > -1;
                $(this).toggle(isVisible);
                if (isVisible) isVisibleRowCount++;
                return isVisible;
            });

            // 입력 값이 없으면 테이블 숨기기
            if (value === "") {
                $("#poi-table").hide();
            } else {
                $("#poi-table").show();
            }

            // 검색 결과 갯수 표시
            $("#searchResults p").text('검색 결과: ' + isVisibleRowCount + '개');
        });

        $(document).ready(function () {
            loadPois();
            showPois();
        });

    </script>
</head>
<body>
</body>
</html>